<% content_for :navabr_text_label, "My Hub" %>
<% content_for :navbar_text_path, profile_path %>

<div class="user-hub-page">
  <div class="container py-4 py-md-5">

    <!-- Welcome Banner -->
    <div class="hub-welcome-banner">
      <div class="welcome-content">
        <h1 class="welcome-title">Welcome, <%= current_user.profile_name || current_user.email.split('@').first %>!</h1>
        <p class="welcome-subtitle">Your central hub for all your Carbodata's features!</p>
      </div>
    </div>

    <!-- Profile Header Section -->
    <div class="hub-profile-header">
      <div class="row align-items-center g-4">

        <!-- Avatar -->
        <div class="col-12 col-md-3 text-center">
          <div class="hub-avatar-wrapper">
            <% if current_user.respond_to?(:photo) && current_user.photo.attached? %>
              <%= image_tag current_user.photo, alt: current_user.profile_name, class: "hub-avatar" %>
            <% elsif current_user.respond_to?(:avatar) && current_user.avatar.present? %>
              <%= image_tag current_user.avatar, alt: current_user.profile_name, class: "hub-avatar" %>
            <% else %>
              <div class="hub-avatar-placeholder">
                <%= (current_user.profile_name || current_user.email.split('@').first).first.upcase %>
              </div>
            <% end %>
            <div class="hub-avatar-badge">
              <i class="fas fa-crown"></i>
            </div>
          </div>
        </div>

        <!-- Profile Info & Quick Stats -->
        <div class="col-12 col-md-9">
          <div class="hub-profile-info">

            <!-- Username & Edit Button -->
            <div class="hub-profile-header-wrapper">
              <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-3">
                <div>
                  <h2 class="hub-username mb-1"><%= current_user.profile_name || current_user.email.split('@').first %></h2>
                  <p class="hub-member-since mb-0">Member since <%= current_user.created_at.strftime("%B %Y") %></p>
                </div>
                <%= link_to edit_user_registration_path, class: "btn btn-hub-edit" do %>
                  <i class="fas fa-user-edit me-2"></i>Edit Profile
                <% end %>
              </div>
              <%= link_to edit_user_registration_path, class: "btn-hub-edit-icon" do %>
                <i class="fas fa-pen"></i>
              <% end %>
            </div>

            <!-- Quick Stats Grid -->
            <div class="hub-stats-grid">
              <div class="hub-stat-card">
                <div class="stat-icon"><i class="fas fa-utensils"></i></div>
                <div class="stat-content">
                  <span class="stat-number"><%= current_user.recipes.count %></span>
                  <span class="stat-label">Recipes</span>
                </div>
              </div>
              <div class="hub-stat-card">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-content">
                  <span class="stat-number"><%= current_user.items.count %></span>
                  <span class="stat-label">Products</span>
                </div>
              </div>
              <div class="hub-stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                  <span class="stat-number">28</span>
                  <span class="stat-label">Followers</span>
                </div>
              </div>
            </div>

            <!-- Bio -->
            <% if current_user.respond_to?(:bio) && current_user.bio.present? %>
              <div class="hub-bio">
                <p class="mb-0">
                  <i class="fas fa-quote-left me-2"></i>
                  <%= current_user.bio %>
                </p>
              </div>
            <% end %>

          </div>
        </div>

      </div>
    </div>

    <!-- Latest Recipes Section -->
    <div class="hub-profile-header mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h-default">
          <i class="fas fa-fire me-2" style="color: #d34e4e;"></i>Latest Recipes
        </h3>
        <%= link_to "View All", recipes_path, class: "slide-link" %>
      </div>

      <% if current_user.recipes.any? %>
        <div class="horizontal-scroll-wrapper">
          <div class="horizontal-scroll-container">
            <% @last_recipes.limit(3).each do |recipe| %>
              <%= link_to recipe_path(recipe), class: "recipe-card-link" do %>
                <div class="recipe-card">
                  <div class="recipe-card-image" style="background-image: url('<%= recipe.photo.attached? ? url_for(recipe.photo) : ENV['DEFAULT_RECIPE_IMAGE_URL'] %>');">
                    <div class="recipe-card-badges">
                      <div class="gi-badge gi-<%= recipe.gi_level %>">
                        <i class="bi bi-droplet-fill"></i>
                        <span><%= recipe.indice_gly %></span>
                      </div>
                      <div class="carb-badge carb-<%= recipe.gi_level %>">
                        <i class="bi bi-lightning-charge-fill"></i>
                        <span><%= recipe.ratio_glucide %>g</span>
                      </div>
                    </div>
                    <div class="recipe-card-content">
                      <h3><%= recipe.name %></h3>
                      <div class="recipe-ratings">
                        <div class="rating-item">
                          <span class="rating-label">GI:</span>
                          <div class="rating-icons rating-gi-<%= recipe.gi_level %>">
                            <% reversed_gi = [5 - recipe.gi_stars, 1].max %>
                            <% reversed_gi.times do %>
                              <i class="bi bi-droplet-fill"></i>
                            <% end %>
                            <% (5 - reversed_gi).times do %>
                              <i class="bi bi-droplet"></i>
                            <% end %>
                          </div>
                        </div>
                        <div class="rating-item">
                          <span class="rating-label">Carbs:</span>
                          <div class="rating-icons rating-carb-<%= recipe.gi_level %>">
                            <% reversed_carb = [5 - recipe.carb_stars, 1].max %>
                            <% reversed_carb.times do %>
                              <i class="bi bi-lightning-charge-fill"></i>
                            <% end %>
                            <% (5 - reversed_carb).times do %>
                              <i class="bi bi-lightning-charge"></i>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="empty-state-mini">
          <i class="fas fa-utensils mb-2"></i>
          <p>No recipes yet</p>
          <%= link_to "Create your first recipe", new_recipe_path, class: "btn btn-sm btn-hub-primary" %>
        </div>
      <% end %>
    </div>

    <!-- Latest Products Section -->
    <div class="hub-profile-header mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h-default">
          <i class="fas fa-box-open me-2" style="color: #d34e4e;"></i>Latest Products
        </h3>
        <%= link_to "View All", items_path, class: "slide-link" %>
      </div>

      <% if current_user.items.any? %>
        <%
          items_by_level = {
            'low' => current_user.items.select { |i| i.gi_level == 'low' }.last(3),
            'medium' => current_user.items.select { |i| i.gi_level == 'medium' }.last(3),
            'high' => current_user.items.select { |i| i.gi_level == 'high' }.last(3)
          }
        %>
        <% items_by_level.each do |level, items| %>
          <% if items.any? %>
            <div class="horizontal-scroll-wrapper mb-3">
              <div class="horizontal-scroll-container">
                <% items.each do |item| %>
                  <div class="item-card">
                    <div class="item-card-gradient item-gi-<%= item.gi_level %>">
                      <div class="item-card-header">
                        <div class="item-card-badges">
                          <div class="gi-badge gi-<%= item.gi_level %>">
                            <i class="bi bi-droplet-fill"></i>
                            <span><%= item.indice_gly %></span>
                          </div>
                          <div class="carb-badge carb-<%= item.gi_level %>">
                            <i class="bi bi-lightning-charge-fill"></i>
                            <span><%= item.ratio_glucide %>g</span>
                          </div>
                        </div>
                      </div>
                      <div class="item-card-body">
                        <h3><%= item.name %></h3>
                        <p class="item-brand"><%= item.brand %></p>
                        <div class="recipe-ratings">
                          <div class="rating-item">
                            <span class="rating-label">GI:</span>
                            <div class="rating-icons rating-gi-<%= item.gi_level %>">
                              <% reversed_gi = [5 - item.gi_stars, 1].max %>
                              <% reversed_gi.times do %>
                                <i class="bi bi-droplet-fill"></i>
                              <% end %>
                              <% (5 - reversed_gi).times do %>
                                <i class="bi bi-droplet"></i>
                              <% end %>
                            </div>
                          </div>
                          <div class="rating-item">
                            <span class="rating-label">Carbs:</span>
                            <div class="rating-icons rating-carb-<%= item.gi_level %>">
                              <% reversed_carb = [5 - item.carb_stars, 1].max %>
                              <% reversed_carb.times do %>
                                <i class="bi bi-lightning-charge-fill"></i>
                              <% end %>
                              <% (5 - reversed_carb).times do %>
                                <i class="bi bi-lightning-charge"></i>
                              <% end %>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div class="empty-state-mini">
          <i class="fas fa-box mb-2"></i>
          <p>No products yet</p>
          <%= link_to "Add your first product", items_path, class: "btn btn-sm btn-hub-primary" %>
        </div>
      <% end %>
    </div>

    <!-- Full Collection Tabs -->
    <div class="hub-tabs-wrapper mt-5">
      <ul class="nav nav-tabs hub-tabs" id="hubTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="recipes-tab" data-bs-toggle="tab" data-bs-target="#recipes" type="button" role="tab" aria-controls="recipes" aria-selected="true">
            <i class="fas fa-utensils me-2"></i>My posts
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="favourites-tab" data-bs-toggle="tab" data-bs-target="#favourites" type="button" role="tab" aria-controls="favourites" aria-selected="false">
            <i class="fas fa-star me-2"></i>Favourites
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content hub-tab-content" id="hubTabsContent">

        <!-- All Posts Tab -->
        <div class="tab-pane fade show active" id="recipes" role="tabpanel" aria-labelledby="recipes-tab">
          <div class="feed-posts mt-3">
            <% if current_user.posts.any? %>
              <% current_user.posts.each do |post| %>
                <article class="feed-card rounded-4 mb-4 shadow-sm" style="background-color: #fafafa; border: 1px solid #eee;">

                  <!-- Post Header -->
                  <div class="feed-card-header">
                    <div class="d-flex align-items-center">
                      <div class="feed-author-avatar">
                        <% if current_user.photo.attached? %>
                          <%= image_tag current_user.photo, alt: current_user.profile_name, class: "avatar-img" %>
                        <% else %>
                          <div class="avatar-placeholder">
                            <%= (current_user.profile_name || current_user.email.split('@').first).first.upcase %>
                          </div>
                        <% end %>
                      </div>
                      <div class="flex-grow-1 ms-3">
                        <span class="feed-author-name">
                          <%= current_user.profile_name || current_user.email.split('@').first %>
                        </span>
                        <div class="feed-post-time">
                          <%= time_ago_in_words(post.created_at) %> ago
                        </div>
                      </div>
                      <div class="dropdown">
                        <button class="btn btn-link text-dark p-1" type="button" data-bs-toggle="dropdown">
                          <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><%= link_to "Edit", edit_post_path(post), class: "dropdown-item" %></li>
                          <li><%= link_to "Delete", post_path(post), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "dropdown-item text-danger" %></li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- Post Image (if available) -->
                  <% if post.respond_to?(:photo) && post.photo.attached? %>
                    <div class="feed-card-image">
                      <%= image_tag post.photo, alt: post.title, class: "post-image" %>
                    </div>
                  <% end %>

                  <!-- Post Actions -->
                  <div class="feed-card-actions">
                    <div class="d-flex gap-3 align-items-center">
                      <!-- Reddit-style voting -->
                      <div class="vote-buttons">
                        <button class="btn-vote upvote-btn" data-post-id="<%= post.id %>">
                          <i class="fas fa-arrow-up"></i>
                        </button>
                        <span class="vote-count" data-post-id="<%= post.id %>">
                          <%= (post.up || 0) - (post.down || 0) %>
                        </span>
                        <button class="btn-vote downvote-btn" data-post-id="<%= post.id %>">
                          <i class="fas fa-arrow-down"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Post Content -->
                  <div class="feed-card-content">
                    <p class="mb-1">
                      <span class="feed-author-name-inline">
                        <%= current_user.profile_name || current_user.email.split('@').first %>
                      </span>
                      <% if post.title.present? %>
                        <strong class="post-title-inline"><%= post.title %></strong>
                      <% end %>
                      <% if post.content.present? %>
                        <span class="post-content-text"><%= post.content %></span>
                      <% end %>
                    </p>
                  </div>

                  <!-- Comments Section -->
                  <div class="feed-card-comments">
                    <% if post.comments.any? %>
                      <% if post.comments.count > 2 %>
                        <%= link_to "View all #{post.comments.count} comments", post_path(post), class: "view-all-comments" %>
                      <% end %>
                      <%= render 'shared/comments', comments: post.comments.order(created_at: :desc).limit(2), post: post %>
                    <% end %>
                  </div>

                </article>
              <% end %>
            <% else %>
              <div class="feed-empty-state">
                <i class="fas fa-utensils"></i>
                <h3>No posts yet</h3>
                <p>Share your first post with the community!</p>
                <%= link_to "Create a post", new_post_path, class: "btn btn-hub-primary" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Favourites Tab -->
        <div class="tab-pane fade" id="favourites" role="tabpanel" aria-labelledby="favourites-tab">
          <div class="row g-4 mt-2">
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-star mb-3"></i>
                <p>No favourites yet</p>
                <small class="text-muted">Start liking recipes and products to see them here</small>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasAction" aria-labelledby="offcanvasActionLabel">
  <div class="offcanvas-dialog offcanvas-dialog-centered">
    <div class="offcanvas-content">
      <div class="offcanvas-header">
        <h6 class="h-default fw-bold w-100 text-center mb-0">Search</h6>
        <button type="button" class="btn-close position-absolute end-0 me-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div class="container-fluid px-3 py-4">
          <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
              <!-- Search Form -->
              <div class="card shadow-sm mb-4">
                <div class="card-body p-3 search-form-wrapper">
                  <%= form_with url: profile_path, method: :get, data: { turbo_frame: "search_results" } do |f| %>
                    <div class="search-input-group">
                      <div class="search-input-container">
                        <%= f.text_field :query,
                            value: params[:query],
                            placeholder: "Search items, posts, recipes...",
                            class: "form-control",
                            autofocus: true %>
                      </div>
                      <div class="search-button-container">
                        <%= f.submit "Search", class: "btn button-default w-100" %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Search Results -->
              <%= turbo_frame_tag "search_results" do %>
                <% if params[:query].present? %>
                  <div class="results-section">
                    <h5 class="mb-3">
                      <%= @results.any? ? "#{@results.count} result#{'s' if @results.count != 1}" : "No results" %>
                    </h5>

                    <% if @results.any? %>
                      <div class="d-flex flex-column gap-2">
                        <% @results.each do |result| %>
                          <% searchable = result.searchable %>
                          <% if searchable %>
                            <%= link_to polymorphic_path(searchable), class: "card text-decoration-none shadow-sm", data: { turbo_frame: "_top" } do %>
                              <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                  <div class="flex-grow-1 pe-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                      <span class="badge bg-primary text-nowrap"><%= searchable.class.name %></span>
                                      <h6 class="mb-0 fw-bold">
                                        <% if searchable.is_a?(Item) %>
                                          <%= searchable.name %>
                                        <% elsif searchable.is_a?(Post) %>
                                          <%= searchable.title %>
                                        <% elsif searchable.is_a?(Recipe) %>
                                          <%= searchable.name %>
                                        <% end %>
                                      </h6>
                                    </div>

                                    <% if searchable.is_a?(Item) %>
                                      <p class="mb-1 small text-muted"><%= searchable.brand %></p>
                                      <p class="mb-0 small">
                                        <span class="badge bg-light text-dark"><%= searchable.category %></span>
                                        <span class="badge bg-light text-dark">IG: <%= searchable.indice_gly %></span>
                                      </p>
                                    <% elsif searchable.is_a?(Post) %>
                                      <p class="mb-1 small text-muted"><%= truncate(searchable.content, length: 100) %></p>
                                    <% elsif searchable.is_a?(Recipe) %>
                                      <p class="mb-1 small text-muted"><%= truncate(searchable.description, length: 100) %></p>
                                    <% end %>

                                    <% if searchable.respond_to?(:user) && searchable.user %>
                                      <small class="text-muted d-block mt-1">
                                        By <%= searchable.user.profile_name || searchable.user.email.split('@').first %>
                                      </small>
                                    <% end %>
                                  </div>
                                  <i class="fas fa-chevron-right text-muted align-self-center"></i>
                                </div>
                              </div>
                            <% end %>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-center text-muted py-5">
                    <i class="fas fa-search fa-3x mb-3 d-block"></i>
                    <p class="px-3">Enter a search query to find items, posts, and recipes.</p>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
