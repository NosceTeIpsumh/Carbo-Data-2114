<% content_for :navabr_text_label, "My Hub" %>
<% content_for :navbar_text_path, profile_path %>

<div class="user-hub-page">
  <div class="container py-4 py-md-5">

    <!-- Welcome Banner -->
    <div class="hub-welcome-banner">
      <div class="welcome-content">
        <h1 class="welcome-title">Welcome, <%= current_user.profile_name || current_user.email.split('@').first %>!</h1>
        <p class="welcome-subtitle">Your central hub for all your Carbodata's features!</p>
      </div>
    </div>

    <!-- Profile Header Section -->
    <div class="hub-profile-header">
      <div class="row align-items-center g-4">

        <!-- Avatar -->
        <div class="col-12 col-md-3 text-center">
          <div class="hub-avatar-wrapper">
            <% if current_user.respond_to?(:photo) && current_user.photo.attached? %>
              <%= image_tag current_user.photo, alt: current_user.profile_name, class: "hub-avatar" %>
            <% elsif current_user.respond_to?(:avatar) && current_user.avatar.present? %>
              <%= image_tag current_user.avatar, alt: current_user.profile_name, class: "hub-avatar" %>
            <% else %>
              <div class="hub-avatar-placeholder">
                <%= (current_user.profile_name || current_user.email.split('@').first).first.upcase %>
              </div>
            <% end %>
            <div class="hub-avatar-badge">
              <i class="fas fa-crown"></i>
            </div>
          </div>
        </div>

        <!-- Profile Info & Quick Stats -->
        <div class="col-12 col-md-9">
          <div class="hub-profile-info">

            <!-- Username & Edit Button -->
            <div class="hub-profile-header-wrapper">
              <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-3">
                <div>
                  <h2 class="hub-username mb-1"><%= current_user.profile_name || current_user.email.split('@').first %></h2>
                  <p class="hub-member-since mb-0">Member since <%= current_user.created_at.strftime("%B %Y") %></p>
                </div>
                <%= link_to edit_user_registration_path, class: "btn btn-hub-edit" do %>
                  <i class="fas fa-user-edit me-2"></i>Edit Profile
                <% end %>
              </div>
              <%= link_to edit_user_registration_path, class: "btn-hub-edit-icon" do %>
                <i class="fas fa-pen"></i>
              <% end %>
            </div>

            <!-- Quick Stats Grid -->
            <div class="hub-stats-grid">
              <div class="hub-stat-card">
                <div class="stat-icon"><i class="fas fa-utensils"></i></div>
                <div class="stat-content">
                  <span class="stat-number"><%= current_user.recipes.count %></span>
                  <span class="stat-label">Recipes</span>
                </div>
              </div>
              <div class="hub-stat-card">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-content">
                  <span class="stat-number"><%= current_user.items.count %></span>
                  <span class="stat-label">Products</span>
                </div>
              </div>
              <div class="hub-stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                  <span class="stat-number">28</span>
                  <span class="stat-label">Followers</span>
                </div>
              </div>
            </div>

            <!-- Bio -->
            <% if current_user.respond_to?(:bio) && current_user.bio.present? %>
              <div class="hub-bio">
                <p class="mb-0">
                  <i class="fas fa-quote-left me-2"></i>
                  <%= current_user.bio %>
                </p>
              </div>
            <% end %>

          </div>
        </div>

      </div>
    </div>

    <!-- Latest Items Carousel -->
    <div class="hub-carousel-section">
      <div class="carousel-header">
        <h3 class="carousel-title">
          <i class="fas fa-star me-2"></i>Latest Activity
        </h3>
      </div>

      <div id="hubCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">
        <div class="carousel-inner">
          <!-- Slide 1: Latest Recipes -->
          <div class="carousel-item active">
            <div class="carousel-slide-content">
              <div class="carousel-slide-header">
                <h4 class="slide-title">
                  <i class="fas fa-fire me-2"></i>Latest Recipes
                </h4>
                <%= link_to "View All", recipes_path, class: "slide-link", data: { bs_toggle: "tab" } %>
              </div>

              <% if current_user.recipes.any? %>
                <div class="carousel-cards-wrapper">
                  <% @last_recipes.limit(3).each do |recipe| %>
                    <%= link_to recipe_path(recipe), class: "hub-carousel-card text-decoration-none" do %>
                      <div class="recipe-card-image" style="background-image: url('https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=500&h=750&fit=crop');">
                        <div class="recipe-card-content">
                          <h5 class="carousel-card-title"><%= recipe.name %></h5>
                          <p class="carousel-card-meta">
                            <i class="fas fa-clock me-1"></i>
                            <%= time_ago_in_words(recipe.created_at) %> ago
                          </p>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% else %>
                <div class="empty-state-mini">
                  <i class="fas fa-utensils mb-2"></i>
                  <p>No recipes yet</p>
                  <%= link_to "Create your first recipe", new_recipe_path, class: "btn btn-sm btn-hub-primary" %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Slide 2: Latest Products -->
          <div class="carousel-item">
            <div class="carousel-slide-content">
              <div class="carousel-slide-header">
                <h4 class="slide-title">
                  <i class="fas fa-box-open me-2"></i>Latest Products
                </h4>
                <%= link_to "View All", "#products", class: "slide-link", data: { bs_toggle: "tab" } %>
              </div>

              <% if current_user.items.any? %>
                <div class="carousel-cards-wrapper">
                  <% @last_items.limit(3).each do |item| %>
                    <%= link_to item_path(item), class: "hub-carousel-card" do %>
                      <div class="carousel-card-placeholder">
                        <i class="fas fa-box"></i>
                      </div>
                      <div class="carousel-card-content">
                        <h5 class="carousel-card-title"><%= item.name %></h5>
                        <p class="carousel-card-meta">
                          <i class="fas fa-clock me-1"></i>
                          <%= time_ago_in_words(item.created_at) %> ago
                        </p>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% else %>
                <div class="empty-state-mini">
                  <i class="fas fa-box mb-2"></i>
                  <p>No products yet</p>
                  <%= link_to "Add your first product", items_path, class: "btn btn-sm btn-hub-primary" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Carousel Controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#hubCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#hubCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>

        <!-- Carousel Indicators -->
        <div class="carousel-indicators hub-carousel-indicators">
          <button type="button" data-bs-target="#hubCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Latest Recipes"></button>
          <button type="button" data-bs-target="#hubCarousel" data-bs-slide-to="1" aria-label="Latest Products"></button>
        </div>
      </div>
    </div>

    <!-- Full Collection Tabs -->
    <div class="hub-tabs-wrapper mt-5">
      <ul class="nav nav-tabs hub-tabs" id="hubTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="recipes-tab" data-bs-toggle="tab" data-bs-target="#recipes" type="button" role="tab" aria-controls="recipes" aria-selected="true">
            <i class="fas fa-utensils me-2"></i>My posts
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="favourites-tab" data-bs-toggle="tab" data-bs-target="#favourites" type="button" role="tab" aria-controls="favourites" aria-selected="false">
            <i class="fas fa-star me-2"></i>Favourites
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content hub-tab-content" id="hubTabsContent">

        <!-- All Recipes Tab -->
        <div class="tab-pane fade show active" id="recipes" role="tabpanel" aria-labelledby="recipes-tab">
          <div class="row g-4 mt-2">
            <% if current_user.posts.any? %>
              <% current_user.posts.each do |post| %>
                <div class="col-6 col-md-4 col-lg-3">
                  <%= link_to post_path(post), class: "hub-card-link" do %>
                    <div class="hub-card">
                      <div class="hub-card-placeholder">
                        <i class="fas fa-utensils"></i>
                      </div>
                      <div class="hub-card-overlay">
                        <div class="hub-card-stats">
                          <span><i class="fas fa-heart"></i> 30</span>
                          <span><i class="fas fa-comment"></i> 12</span>
                        </div>
                      </div>
                      <div class="hub-card-title">
                        <%= post.title %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="col-12">
                <div class="empty-state">
                  <i class="fas fa-utensils mb-3"></i>
                  <p>No posts in your collection</p>
                  <%= link_to "Share your first post", posts_path, class: "btn btn-hub-primary" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Favourites Tab -->
        <div class="tab-pane fade" id="favourites" role="tabpanel" aria-labelledby="favourites-tab">
          <div class="row g-4 mt-2">
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-star mb-3"></i>
                <p>No favourites yet</p>
                <small class="text-muted">Start liking recipes and products to see them here</small>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<div class="offcanvas offcanvas-end", tabindex="-1", id="offcanvasAction", aria-labelledby="offcanvasActionLabel">
  <div class="offcanvas-dialog offcanvas-dialog-centered">
    <div class="offcanvas-content">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title p-default" id="offcanvasActionLabel">Browse!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div class="container-fluid px-3 py-4">
          <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
              <h1 class="text-center h-default mb-4">Search</h1>

              <!-- Search Form -->
              <div class="card shadow-sm mb-4">
                <div class="card-body p-3 search-form-wrapper">
                  <%= form_with url: browse_path, method: :get, local: true do |f| %>
                    <div class="search-input-group">
                      <div class="search-input-container">
                        <%= f.text_field :query,
                            value: params[:query],
                            placeholder: "Search items, posts, recipes...",
                            class: "form-control",
                            autofocus: true %>
                      </div>
                      <div class="search-button-container">
                        <%= f.submit "Search", class: "btn button-default w-100" %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Search Results -->
              <% if params[:query].present? %>
                <div class="results-section">
                  <h5 class="mb-3">
                    <%= @results.any? ? "#{@results.count} result#{'s' if @results.count != 1}" : "No results" %>
                  </h5>

                  <% if @results.any? %>
                    <div class="d-flex flex-column gap-2">
                      <% @results.each do |result| %>
                        <% searchable = result.searchable %>
                        <% if searchable %>
                          <%= link_to polymorphic_path(searchable), class: "card text-decoration-none shadow-sm" do %>
                            <div class="card-body p-3">
                              <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1 pe-2">
                                  <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <span class="badge bg-primary text-nowrap"><%= searchable.class.name %></span>
                                    <h6 class="mb-0 fw-bold">
                                      <% if searchable.is_a?(Item) %>
                                        <%= searchable.name %>
                                      <% elsif searchable.is_a?(Post) %>
                                        <%= searchable.title %>
                                      <% elsif searchable.is_a?(Recipe) %>
                                        <%= searchable.name %>
                                      <% end %>
                                    </h6>
                                  </div>

                                  <% if searchable.is_a?(Item) %>
                                    <p class="mb-1 small text-muted"><%= searchable.brand %></p>
                                    <p class="mb-0 small">
                                      <span class="badge bg-light text-dark"><%= searchable.category %></span>
                                      <span class="badge bg-light text-dark">IG: <%= searchable.indice_gly %></span>
                                    </p>
                                  <% elsif searchable.is_a?(Post) %>
                                    <p class="mb-1 small text-muted"><%= truncate(searchable.content, length: 100) %></p>
                                  <% elsif searchable.is_a?(Recipe) %>
                                    <p class="mb-1 small text-muted"><%= truncate(searchable.description, length: 100) %></p>
                                  <% end %>

                                  <% if searchable.respond_to?(:user) && searchable.user %>
                                    <small class="text-muted d-block mt-1">
                                      By <%= searchable.user.profile_name || searchable.user.email.split('@').first %>
                                    </small>
                                  <% end %>
                                </div>
                                <i class="fas fa-chevron-right text-muted align-self-center"></i>
                              </div>
                            </div>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="text-center text-muted py-5">
                  <i class="fas fa-search fa-3x mb-3 d-block"></i>
                  <p class="px-3">Enter a search query to find items, posts, and recipes.</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
