<% content_for :navabr_text_label, "My Carbomeals" %>
<% content_for :navbar_text_path, feed_path %>

<div class="container">
  <div class="shadow-sm rounded-5 mt-4 p-4 segment-control-bar">
    <%= link_to 'Carbomeals', recipes_path, class: "btn segment-button #{'active' if current_page?(recipes_path)}" %>
    <%= link_to 'Carboducts', items_path, class: "btn segment-button #{'active' if current_page?(items_path)}" %>
  </div>

  <div class="card shadow-sm rounded-5 mt-4 p-4">
    <%= form_with url: recipes_path, method: :get, class: "d-flex" do %>
      <%= label_tag :query, "Search in your CarboMeals", class: "visually-hidden" %>
      <%= text_field_tag :query,
            params[:query],
            class: "form-control me-2",
            placeholder: "Type a keyword"
        %>
      <%= submit_tag "Search", name: "", class: "btn button-default" %>
    <% end %>
  </div>

  <%
    carousels = [
      { id: 'carousel1', title: 'Low GI Recipes', recipes: @low_gi_recipes, level: 'low' },
      { id: 'carousel2', title: 'Medium GI Recipes', recipes: @medium_gi_recipes, level: 'medium' },
      { id: 'carousel3', title: 'High GI Recipes', recipes: @high_gi_recipes, level: 'high' }
    ]
  %>

  <% carousels.each do |carousel| %>
    <div class="carousel-section mt-4">
      <h2 class="h-default mb-3">
        <span class="recipe-count recipe-count-<%= carousel[:level] %>">
          <i class="bi bi-droplet-fill"></i>
          <span class="count-number"><%= carousel[:recipes].count %></span>
        </span>
        <%= carousel[:title] %>
      </h2>
      <div class="horizontal-scroll-wrapper">
        <div class="horizontal-scroll-container">
          <% carousel[:recipes].each do |recipe| %>
            <%= link_to "#", class: "recipe-card-link", data: { bs_toggle: "offcanvas", bs_target: "#offcanvasRecipe#{recipe.id}" } do %>
              <div class="recipe-card">
                <div class="recipe-card-image" style="background-image: url('<%= recipe.photo.attached? ? url_for(recipe.photo) : Recipe::DEFAULT_IMAGE_URL %>');">
                  <div class="recipe-card-badges">
                    <div class="gi-badge gi-<%= recipe.gi_level %>">
                      <i class="bi bi-droplet-fill"></i>
                      <span><%= recipe.indice_gly %></span>
                    </div>
                    <div class="carb-badge carb-<%= recipe.gi_level %>">
                      <i class="bi bi-lightning-charge-fill"></i>
                      <span><%= recipe.ratio_glucide %>g</span>
                    </div>
                  </div>
                  <div class="recipe-card-content">
                    <h3><%= recipe.name %></h3>
                    <div class="recipe-ratings">
                      <div class="rating-item">
                        <span class="rating-label">Glycemic Index:</span>
                        <div class="rating-icons rating-gi-<%= recipe.gi_level %>">
                          <% reversed_gi = [5 - recipe.gi_stars, 1].max %>
                          <% reversed_gi.times do %>
                            <i class="bi bi-droplet-fill"></i>
                          <% end %>
                          <% (5 - reversed_gi).times do %>
                            <i class="bi bi-droplet"></i>
                          <% end %>
                        </div>
                      </div>
                      <div class="rating-item">
                        <span class="rating-label">Carbs:</span>
                        <div class="rating-icons rating-carb-<%= recipe.gi_level %>">
                          <% reversed_carb = [5 - recipe.carb_stars, 1].max %>
                          <% reversed_carb.times do %>
                            <i class="bi bi-lightning-charge-fill"></i>
                          <% end %>
                          <% (5 - reversed_carb).times do %>
                            <i class="bi bi-lightning-charge"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% [@low_gi_recipes, @medium_gi_recipes, @high_gi_recipes].flatten.each do |recipe| %>
    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasRecipe<%= recipe.id %>" aria-labelledby="offcanvasRecipeLabel<%= recipe.id %>" data-bs-backdrop="true">
      <div class="offcanvas-dialog offcanvas-dialog-centered">
        <div class="offcanvas-content">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title p-default" id="offcanvasRecipeLabel<%= recipe.id %>"><%= recipe.name %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <div class="card shadow-sm rounded-5 p-4 border-0">
              <!-- Recipe Image -->
              <div class="recipe-show-image rounded-4 mb-4" style="background-image: url('<%= recipe.photo.attached? ? url_for(recipe.photo) : Recipe::DEFAULT_IMAGE_URL %>');">
                <div class="recipe-card-badges">
                  <div class="gi-badge gi-<%= recipe.gi_level %>">
                    <i class="bi bi-droplet-fill"></i>
                    <span><%= recipe.indice_gly %></span>
                  </div>
                  <div class="carb-badge carb-<%= recipe.gi_level %>">
                    <i class="bi bi-lightning-charge-fill"></i>
                    <span><%= recipe.ratio_glucide %>g</span>
                  </div>
                </div>
              </div>

              <!-- Description -->
              <% if recipe.description.present? %>
                <div class="mb-4 text-center">
                  <p class="p-default text-muted"><%= recipe.description %></p>
                </div>
              <% end %>

              <!-- Ratings Section -->
              <div class="recipe-show-ratings mb-4">
                <div class="rating-item">
                  <span class="rating-label p-default">GI</span>
                  <div class="rating-icons rating-gi-<%= recipe.gi_level %>">
                    <% reversed_gi = [5 - recipe.gi_stars, 1].max %>
                    <% reversed_gi.times do %>
                      <i class="bi bi-droplet-fill"></i>
                    <% end %>
                    <% (5 - reversed_gi).times do %>
                      <i class="bi bi-droplet"></i>
                    <% end %>
                  </div>
                </div>
                <div class="rating-item">
                  <span class="rating-label p-default">Glucides</span>
                  <div class="rating-icons rating-carb-<%= recipe.gi_level %>">
                    <% reversed_carb = [5 - recipe.carb_stars, 1].max %>
                    <% reversed_carb.times do %>
                      <i class="bi bi-lightning-charge-fill"></i>
                    <% end %>
                    <% (5 - reversed_carb).times do %>
                      <i class="bi bi-lightning-charge"></i>
                    <% end %>
                  </div>
                </div>
                <div class="rating-item">
                  <span class="rating-label p-default">Difficulty</span>
                  <div class="rating-icons rating-difficulty">
                    <% recipe.difficulty.to_i.times do %>
                      <i class="bi bi-star-fill"></i>
                    <% end %>
                    <% (5 - recipe.difficulty.to_i).times do %>
                      <i class="bi bi-star"></i>
                    <% end %>
                  </div>
                </div>
              </div>

              <hr class="my-4">

              <% if recipe.steps.present? %>
                <div class="mb-4">
                  <h3 class="h-default mb-3">Steps</h3>
                  <div class="recipe-show-steps p-default">
                    <% recipe.steps.split(/(?=\d+\.)/).reject(&:blank?).each do |step| %>
                      <% match = step.strip.match(/^(\d+)\.\s*(.*)/) %>
                      <% if match %>
                        <div class="step-item">
                          <div class="step-number"><%= match[1] %></div>
                          <div class="step-content"><%= match[2] %></div>
                        </div>
                      <% else %>
                        <div class="step-item">
                          <div class="step-content"><%= step.strip %></div>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <div class="recipe-show-actions mt-4">
                <%= link_to edit_recipe_path(recipe), class: "btn button-default rounded-5" do %>
                  <i class="bi bi-pencil me-2"></i>Edit
                <% end %>

                <%= link_to recipe_path(recipe),
                    data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this recipe?" },
                    class: "btn btn-outline-danger rounded-5" do %>
                  <i class="bi bi-trash me-2"></i>Delete
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasAction" aria-labelledby="offcanvasActionLabel" data-bs-backdrop="true" data-controller="wizard">
  <div class="offcanvas-dialog offcanvas-dialog-centered">
    <div class="offcanvas-content">
      <div class="offcanvas-header">
         <h6 class="h-default text-center fw-bold">
                How would you like to create your CarboMeal?
         </h6>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-action="wizard#reset"></button>
      </div>
      <div class="offcanvas-body">

        <div data-wizard-target="step" class="wizard-step">
          <div class="container">
            <div class="card shadow-sm rounded-5 border-0 modal-carbo-card">
              <div class="d-grid gap-3">
                <button type="button" class="btn button-default btn-lg rounded-5" data-action="wizard#goToNext" data-current-step="0" data-next-step="1">
                  <i class="fa-solid fa-pencil me-2"></i>Add manually
                </button>
                <button type="button" class="btn button-default btn-lg rounded-5" data-action="wizard#goToNext" data-current-step="0" data-next-step="4">
                  <i class="fa-solid fa-robot me-2"></i>Ask SuperCarbo
                </button>
              </div>
            </div>
          </div>
        </div>

        <%= simple_form_for @recipe do |f| %>
          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Step 1: Name and Description
                </h6>
                <%= f.input :name, placeholder: "Give your recipe a name...", input_html: { class: "placeholder-custom" } %>
                <%= f.input :description, placeholder: "A brief description of your recipe", input_html: { class: "placeholder-custom" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="1" data-previous-step="0">
                    <i class="fa-solid fa-arrow-left me-2"></i>Back
                  </button>
                  <button type="button" class="btn button-default rounded-5" data-action="wizard#goToNext" data-current-step="1" data-next-step="2">
                    Next<i class="fa-solid fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Step 2: Instructions and Difficulty
                </h6>
                <%= f.input :steps, placeholder: "Step by step instructions for your recipe", input_html: { class: "placeholder-custom", rows: 5 } %>
                <%= f.input :difficulty, collection: [1,2,3,4,5], prompt: "1 for very easy, 5 for very difficult", input_html: { class: "form-select custom-font" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="2" data-previous-step="1">
                    <i class="fa-solid fa-arrow-left me-2"></i>Back
                  </button>
                  <button type="button" class="btn button-default rounded-5" data-action="wizard#goToNext" data-current-step="2" data-next-step="3">
                    Next<i class="fa-solid fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Step 3: Nutritional Data
                </h6>
                <%= f.input :indice_gly, placeholder: "Glycemic index (1-100)", input_html: { class: "placeholder-custom" } %>
                <%= f.input :ratio_glucide, placeholder: "Carb ratio (1-100)", input_html: { class: "placeholder-custom" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="3" data-previous-step="2">
                    <i class="fa-solid fa-arrow-left me-2"></i>Back
                  </button>
                  <%= f.submit "Save", class: "btn button-default rounded-5" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div data-wizard-target="step" class="wizard-step d-none">
          <div class="container py-1">
            <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
              <h6 class="h-default text-center fw-bold mb-4">
                Choose which CarboDucts you want to include in your recipes! If you don't select any, our SuperCarbo will take care of it!
              </h6>

              <% if @items.any? %>
                <%= simple_form_for @chat_item do |f| %>
                  <%= f.association :item,
                      as: :check_boxes,
                      label: "",
                      label_method: :show_name_and_brand,
                      collection_wrapper_tag: 'div',
                      collection_wrapper_class: 'category-wrapper',
                      item_wrapper_tag: 'div',
                      item_wrapper_class: 'category-item',
                      input_html: { class: 'category-selector' },
                      collection: current_user.items
                  %>
                  <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="4" data-previous-step="0">
                      <i class="fa-solid fa-arrow-left me-2"></i>Back
                    </button>
                    <%= f.button :submit, "Start Chat", class: 'btn button-default rounded-5' %>
                  </div>
                <% end %>
              <% else %>
                <p class="text-center mb-4 p-default">You don't have any CarboDucts yet. SuperCarbo will create a recipe without specific ingredients.</p>
                <%= simple_form_for @chat_item do |f| %>
                  <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="4" data-previous-step="0">
                      <i class="fa-solid fa-arrow-left me-2"></i>Back
                    </button>
                    <%= f.button :submit, "Start Chat", class: 'btn button-default rounded-5' %>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
