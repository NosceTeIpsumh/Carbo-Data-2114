<% content_for :navabr_text_label, "My CarboMeals" %>
<% content_for :navbar_text_path, feed_path %>

<div class="container">
  <div class="shadow-sm rounded-5 mt-4 p-4 segment-control-bar">
    <%= link_to 'Carbomeals', recipes_path, class: "segment-button #{'active' if current_page?(recipes_path)}" %>
    <%= link_to 'Carboducts', items_path, class: "segment-button #{'active' if current_page?(items_path)}" %>
  </div>

  <div class="card shadow-sm rounded-5 mt-4 p-4">
    <%= form_with url: recipes_path, method: :get, class: "d-flex" do %>
      <%= label_tag :query, "Search in your CarboMeals", class: "visually-hidden" %>
      <%= text_field_tag :query,
            params[:query],
            class: "form-control me-2",
            placeholder: "Type a keyword"
        %>
      <%= submit_tag "Search", name: "", class: "button-default" %>
    <% end %>
  </div>

  <%
    # Define carousel data
    carousels = [
      {
        id: 'carousel1',
        title: 'Low GI recipes',
        recipes: [
          { name: 'Quinoa Salad Bowl', image: 'photo-1512621776951-a57141f2eefd', gi: 35, carbs: '20g', gi_stars: 2, carbs_stars: 2, level: 'low' },
          { name: 'Fresh Veggie Salad', image: 'photo-1546069901-ba9599a7e63c', gi: 40, carbs: '25g', gi_stars: 2, carbs_stars: 2, level: 'low' },
          { name: 'Healthy Soup Bowl', image: 'photo-1540189549336-e6e99c3679fe', gi: 30, carbs: '18g', gi_stars: 2, carbs_stars: 1, level: 'low' }
        ]
      },
      {
        id: 'carousel2',
        title: 'Med GI recipes',
        recipes: [
          { name: 'Balanced Bowl', image: 'photo-1482049016688-2d3e1b311543', gi: 65, carbs: '45g', gi_stars: 3, carbs_stars: 3, level: 'medium' },
          { name: 'Mixed Food Plate', image: 'photo-1504674900247-0877df9cc836', gi: 60, carbs: '40g', gi_stars: 3, carbs_stars: 3, level: 'medium' },
          { name: 'Fresh Salad Mix', image: 'photo-1498837167922-ddd27525d352', gi: 58, carbs: '38g', gi_stars: 3, carbs_stars: 3, level: 'medium' }
        ]
      },
      {
        id: 'carousel3',
        title: 'High GI recipes',
        recipes: [
          { name: 'Burger & Fries', image: 'photo-1555939594-58d7cb561ad1', gi: 85, carbs: '70g', gi_stars: 5, carbs_stars: 5, level: 'high' },
          { name: 'Sweet Pancakes', image: 'photo-1567620905732-2d1ec7ab7445', gi: 90, carbs: '75g', gi_stars: 5, carbs_stars: 5, level: 'high' },
          { name: 'Burrito Bowl', image: 'photo-1529042410759-befb1204b468', gi: 80, carbs: '68g', gi_stars: 4, carbs_stars: 4, level: 'high' }
        ]
      }
    ]
  %>

  <% carousels.each do |carousel| %>
    <div class="carousel-section mt-4">
      <h2 class="h-default mb-3"><%= carousel[:title] %></h2>
      <div id="<%= carousel[:id] %>" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          <% carousel[:recipes].each_with_index do |recipe, index| %>
            <div class="carousel-item <%= 'active' if index == 0 %>">
              <div class="recipe-card">
                <div class="recipe-card-image" style="background-image: url('https://images.unsplash.com/<%= recipe[:image] %>?w=500&h=750&fit=crop');">
                  <div class="recipe-card-badges">
                    <div class="gi-badge gi-<%= recipe[:level] %>">
                      <i class="bi bi-droplet-fill"></i>
                      <span><%= recipe[:gi] %></span>
                    </div>
                    <div class="carb-badge carb-<%= recipe[:level] %>">
                      <i class="bi bi-lightning-charge-fill"></i>
                      <span><%= recipe[:carbs] %></span>
                    </div>
                  </div>
                  <div class="recipe-card-content">
                    <h3><%= recipe[:name] %></h3>
                    <div class="recipe-ratings">
                      <div class="rating-item">
                        <span class="rating-label">GI:</span>
                        <div class="rating-stars"><%= '★' * recipe[:gi_stars] + '☆' * (5 - recipe[:gi_stars]) %></div>
                      </div>
                      <div class="rating-item">
                        <span class="rating-label">Glucides:</span>
                        <div class="rating-stars"><%= '★' * recipe[:carbs_stars] + '☆' * (5 - recipe[:carbs_stars]) %></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#<%= carousel[:id] %>" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#<%= carousel[:id] %>" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>

        <div class="carousel-indicators hub-carousel-indicators">
          <% carousel[:recipes].each_with_index do |_, index| %>
            <button type="button" data-bs-target="#<%= carousel[:id] %>" data-bs-slide-to="<%= index %>"
                    class="<%= 'active' if index == 0 %>" <%= 'aria-current="true"' if index == 0 %>></button>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAction" aria-labelledby="offcanvasActionLabel" data-bs-backdrop="true" data-controller="wizard">
  <div class="offcanvas-dialog offcanvas-dialog-centered">
    <div class="offcanvas-content">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title p-default" id="offcanvasActionLabel">Add a New CarboMeal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-action="wizard#reset"></button>
      </div>
      <div class="offcanvas-body">

        <div data-wizard-target="step" class="wizard-step">
          <div class="container py-1">
            <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
              <h6 class="h-default text-center fw-bold mb-4">
                Comment voulez-vous créer votre CarboMeal?
              </h6>
              <div class="d-grid gap-3">
                <button type="button" class="btn button-default btn-lg rounded-5" data-action="wizard#goToNext" data-current-step="0" data-next-step="1">
                  <i class="fa-solid fa-pencil me-2"></i>Ajouter moi-même
                </button>
                <button type="button" class="btn button-default btn-lg rounded-5" data-action="wizard#goToNext" data-current-step="0" data-next-step="4">
                  <i class="fa-solid fa-robot me-2"></i>Demander à SuperCarbo
                </button>
              </div>
            </div>
          </div>
        </div>

        <%= simple_form_for @recipe do |f| %>
          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Étape 1: Nom et Description
                </h6>
                <%= f.input :name, placeholder: "Donne un nom à ta recette...", input_html: { class: "placeholder-custom" } %>
                <%= f.input :description, placeholder: "Une description brève de ta recette", input_html: { class: "placeholder-custom" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="1" data-previous-step="0">
                    <i class="fa-solid fa-arrow-left me-2"></i>Retour
                  </button>
                  <button type="button" class="btn button-default rounded-5" data-action="wizard#goToNext" data-current-step="1" data-next-step="2">
                    Suivant<i class="fa-solid fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Étape 2: Instructions et Difficulté
                </h6>
                <%= f.input :steps, placeholder: "Une description pas à pas de ta recette", input_html: { class: "placeholder-custom", rows: 5 } %>
                <%= f.input :difficulty, collection: [1,2,3,4,5], prompt: "1 pour très facile, 5 pour très difficile", input_html: { class: "form-select custom-font" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="2" data-previous-step="1">
                    <i class="fa-solid fa-arrow-left me-2"></i>Retour
                  </button>
                  <button type="button" class="btn button-default rounded-5" data-action="wizard#goToNext" data-current-step="2" data-next-step="3">
                    Suivant<i class="fa-solid fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Étape 3: Données Nutritionnelles
                </h6>
                <%= f.input :indice_gly, placeholder: "Indice glycémique (1-100)", input_html: { class: "placeholder-custom" } %>
                <%= f.input :ratio_glucide, placeholder: "Ratio glucidique (1-100)", input_html: { class: "placeholder-custom" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="3" data-previous-step="2">
                    <i class="fa-solid fa-arrow-left me-2"></i>Retour
                  </button>
                  <%= f.submit "Enregistrer", class: "btn button-default rounded-5" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div data-wizard-target="step" class="wizard-step d-none">
          <div class="container py-1">
            <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
              <h6 class="h-default text-center fw-bold mb-4">
                Choisissez quels CarboDucts vous voulez intégrer dans vos recettes! Si vous n'en choisissez aucun, notre SuperCarbo s'en occupera!
              </h6>

              <% if @items.any? %>
                <%= simple_form_for @chat_item do |f| %>
                  <%= f.association :item,
                      as: :check_boxes,
                      label: "",
                      label_method: :show_name_and_brand,
                      collection_wrapper_tag: 'div',
                      collection_wrapper_class: 'category-wrapper',
                      item_wrapper_tag: 'div',
                      item_wrapper_class: 'category-item',
                      input_html: { class: 'category-selector' },
                      collection: current_user.items
                  %>
                  <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="4" data-previous-step="0">
                      <i class="fa-solid fa-arrow-left me-2"></i>Retour
                    </button>
                    <%= f.button :submit, "Démarrer le Chat", class: 'btn button-default rounded-5' %>
                  </div>
                <% end %>
              <% else %>
                <p class="text-center mb-4 p-default">Vous n'avez pas encore de CarboDucts. SuperCarbo créera une recette sans ingrédients spécifiques.</p>
                <%= simple_form_for @chat_item do |f| %>
                  <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="4" data-previous-step="0">
                      <i class="fa-solid fa-arrow-left me-2"></i>Retour
                    </button>
                    <%= f.button :submit, "Démarrer le Chat", class: 'btn button-default rounded-5' %>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
