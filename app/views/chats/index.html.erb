<% content_for :navabr_text_label, "Supercarbo" %>
<% content_for :navbar_text_path, chats_path %>

<div class="container">
  <% if @chats.any? %>
    <div class="chats-section mt-4">
      <h2 class="h-default mb-3 chats-header">
        <i class="bi bi-chat-dots chats-header-icon"></i>
        Your Conversations
        <span class="chat-count-badge"><%= @chats.count %></span>
      </h2>

      <div class="chats-list">
        <% @chats.order(updated_at: :desc).each do |chat| %>
          <div class="chat-card">
            <div class="chat-card-icon">
              <i class="bi bi-robot"></i>
            </div>

            <div class="chat-card-body">
              <h3 class="chat-title"><%= chat.title.presence || "New Conversation" %></h3>
              <div class="chat-meta-row">
                <span class="chat-meta">
                  <i class="bi bi-clock"></i>
                  <%= time_ago_in_words(chat.updated_at) %> ago
                </span>
                <span class="chat-meta">
                  <i class="bi bi-chat-left-text"></i>
                  <%= pluralize(chat.messages.count, 'message') %>
                </span>
              </div>
            </div>

            <div class="chat-card-actions">
              <%= link_to chat_path(chat), class: "btn button-default rounded-5 chat-btn-continue" do %>
                <i class="bi bi-box-arrow-in-right me-1"></i><span class="btn-text">Continue</span>
              <% end %>
              <%= link_to chat_path(chat),
                  data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this chat?" },
                  class: "chat-icon-link chat-icon-delete" do %>
                <i class="bi bi-trash"></i>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="empty-state-card shadow-sm rounded-5 mt-4 p-5 text-center">
      <div class="empty-state-icon mb-4">
        <i class="bi bi-robot"></i>
      </div>
      <h2 class="h-default mb-3">No conversations yet</h2>
      <p class="p-default text-muted mb-4">
        Start chatting with SuperCarbo to get personalized low-glycemic recipe suggestions!
      </p>
      <button type="button" class="btn button-default btn-lg rounded-5" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAction">
        <i class="bi bi-plus-circle me-2"></i>Start a New Chat
      </button>
    </div>
  <% end %>
</div>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasAction" aria-labelledby="offcanvasActionLabel" data-bs-backdrop="true">
  <div class="offcanvas-dialog offcanvas-dialog-centered">
    <div class="offcanvas-content">
      <div class="offcanvas-header">
        <h6 class="h-default fw-bold w-100 text-center mb-0">
          Start a New Chat with SuperCarbo
        </h6>
        <button type="button" class="btn-close position-absolute end-0 me-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div class="container py-1">
          <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
            <h6 class="h-default text-center fw-bold mb-4">
              Choose which CarboDucts you want to include in your recipes! If you don't select any, our SuperCarbo will take care of it!
            </h6>

            <% if @items.any? %>
              <%= simple_form_for @chat_item do |f| %>
                <%= f.association :item,
                    as: :check_boxes,
                    label: "",
                    label_method: :show_name_and_brand,
                    collection_wrapper_tag: 'div',
                    collection_wrapper_class: 'category-wrapper',
                    item_wrapper_tag: 'div',
                    item_wrapper_class: 'category-item',
                    input_html: { class: 'category-selector' },
                    collection: current_user.items
                %>
                <div class="d-flex justify-content-center mt-4">
                  <%= f.button :submit, "Start Chat", class: 'btn button-default rounded-5' %>
                </div>
              <% end %>
            <% else %>
              <p class="text-center mb-4 p-default">You don't have any CarboDucts yet. SuperCarbo will create a recipe without specific ingredients.</p>
              <%= simple_form_for @chat_item do |f| %>
                <div class="d-flex justify-content-center mt-4">
                  <%= f.button :submit, "Start Chat", class: 'btn button-default rounded-5' %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
