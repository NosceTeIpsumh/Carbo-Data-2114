<% content_for :navabr_text_label, "My CarboDucts" %>
<% content_for :navbar_text_path, feed_path %>

<div class="container">
  <div class="shadow-sm rounded-5 mt-4 p-4 segment-control-bar">
    <%= link_to 'Carbomeals', recipes_path, class: "btn segment-button #{'active' if current_page?(recipes_path)}" %>
    <%= link_to 'Carboducts', items_path, class: "btn segment-button #{'active' if current_page?(items_path)}" %>
  </div>

  <div class="card shadow-sm rounded-5 mt-4 p-4">
    <%= form_with url: items_path, method: :get, class: "d-flex" do %>
      <%= label_tag :query, "Search in your CarboDucts", class: "visually-hidden" %>
      <%= text_field_tag :query,
            params[:query],
            class: "form-control me-2",
            placeholder: "Type a keyword"
        %>
      <%= submit_tag "Search", name: "", class: "btn button-default" %>
    <% end %>
  </div>

  <%
    category_icons = {
      "Fruits & Vegetables" => "bi-tree",
      "Grains & Legumes" => "bi-basket2",
      "Dairy & Substitutes" => "bi-cup-straw",
      "Meat & Substitutes" => "bi-egg-fried",
      "Fats & Oils" => "bi-droplet-half",
      "Sweets & Sugars" => "bi-cake2",
      "Water" => "bi-water",
      "Alcohol" => "bi-wine",
      "Sugary Drinks" => "bi-cup-straw",
      "Vitamins & Minerals" => "bi-capsule"
    }
  %>

  <% if @items_by_category.any? %>
    <% @items_by_category.each_with_index do |(category, items), cat_index| %>
      <div class="carousel-section mt-4">
        <h2 class="h-default mb-3 category-header">
          <i class="bi <%= category_icons[category] || 'bi-box-seam' %> category-icon"></i>
          <%= category || "No category" %>
        </h2>
        <div class="horizontal-scroll-wrapper">
          <div class="horizontal-scroll-container">
            <% items.each do |item| %>
              <div class="item-card">
                <div class="item-card-gradient item-gi-<%= item.gi_level %>">
                  <div class="item-card-header">
                    <div class="item-card-badges">
                      <div class="gi-badge gi-<%= item.gi_level %>">
                        <i class="bi bi-droplet-fill"></i>
                        <span><%= item.indice_gly %></span>
                      </div>
                      <div class="carb-badge carb-<%= item.gi_level %>">
                        <i class="bi bi-lightning-charge-fill"></i>
                        <span><%= item.ratio_glucide %>g</span>
                      </div>
                    </div>
                    <div class="item-actions-icons">
                      <%= link_to edit_item_path(item), class: "item-icon-link" do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <%= link_to item_path(item),
                          data: { turbo_method: :delete, turbo_confirm: "Êtes-vous sûr(e) de vouloir supprimer ce CarboDuct ?" },
                          class: "item-icon-link item-icon-delete" do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </div>
                  <div class="item-card-body">
                    <h3><%= item.name %></h3>
                    <p class="item-brand"><%= item.brand %></p>
                    <div class="recipe-ratings">
                      <div class="rating-item">
                        <span class="rating-label">GI:</span>
                        <div class="rating-icons rating-gi-<%= item.gi_level %>">
                          <% reversed_gi = [5 - item.gi_stars, 1].max %>
                          <% reversed_gi.times do %>
                            <i class="bi bi-droplet-fill"></i>
                          <% end %>
                          <% (5 - reversed_gi).times do %>
                            <i class="bi bi-droplet"></i>
                          <% end %>
                        </div>
                      </div>
                      <div class="rating-item">
                        <span class="rating-label">Glucides:</span>
                        <div class="rating-icons rating-carb-<%= item.gi_level %>">
                          <% reversed_carb = [5 - item.carb_stars, 1].max %>
                          <% reversed_carb.times do %>
                            <i class="bi bi-lightning-charge-fill"></i>
                          <% end %>
                          <% (5 - reversed_carb).times do %>
                            <i class="bi bi-lightning-charge"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="card shadow-sm rounded-5 mt-4 p-4 text-center">
      <p class="p-default mb-0">Vous n'avez pas encore de CarboDucts. Ajoutez-en un!</p>
    </div>
  <% end %>
</div>


<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAction" aria-labelledby="offcanvasActionLabel" data-bs-backdrop="true" data-controller="wizard">
  <div class="offcanvas-dialog offcanvas-dialog-centered">
    <div class="offcanvas-content">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title p-default" id="offcanvasActionLabel">Add a New CarboDuct</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-action="wizard#reset"></button>
      </div>
      <div class="offcanvas-body">

        <%= simple_form_for @item do |f| %>
          <div data-wizard-target="step" class="wizard-step">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Étape 1: Informations Générales
                </h6>
                <%= f.input :name, placeholder: "Exemple: patate douce, entrecôte, banane...", input_html: { class: "placeholder-custom" } %>
                <%= f.input :brand, placeholder: "Exemple: Panzani, Charal, Cassegrain...", input_html: { class: "placeholder-custom" } %>
                <div class="d-flex justify-content-end mt-3">
                  <button type="button" class="btn button-default rounded-5" data-action="wizard#goToNext" data-current-step="0" data-next-step="1">
                    Suivant<i class="fa-solid fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Étape 2: Catégorie
                </h6>
                <%= f.input :category,
                    as: :radio_buttons,
                    label: false,
                    collection: [
                      "Fruits & Vegetables",
                      "Grains & Legumes",
                      "Dairy & Substitutes",
                      "Meat & Substitutes",
                      "Fats & Oils",
                      "Sweets & Sugars",
                      "Water",
                      "Alcohol",
                      "Sugary Drinks",
                      "Vitamins & Minerals"
                    ],
                    collection_wrapper_tag: 'div',
                    collection_wrapper_class: 'category-wrapper',
                    item_wrapper_tag: 'div',
                    item_wrapper_class: 'form-check',
                    input_html: { class: 'form-check-input' },
                    label_html: { class: 'form-check-label' }
                %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="1" data-previous-step="0">
                    <i class="fa-solid fa-arrow-left me-2"></i>Retour
                  </button>
                  <button type="button" class="btn button-default rounded-5" data-action="wizard#goToNext" data-current-step="1" data-next-step="2">
                    Suivant<i class="fa-solid fa-arrow-right ms-2"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div data-wizard-target="step" class="wizard-step d-none">
            <div class="container py-1">
              <div class="card shadow-sm rounded-5 p-4 border-0 modal-carbo-card">
                <h6 class="h-default text-center fw-bold mb-4">
                  Étape 3: Données Nutritionnelles
                </h6>
                <%= f.input :indice_gly, placeholder: "Compris entre 1 et 100", input_html: { class: "placeholder-custom" } %>
                <%= f.input :ratio_glucide, placeholder: "Pour 100g. Exemple: 27", input_html: { class: "placeholder-custom" } %>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-outline-secondary rounded-5" data-action="wizard#goToPrevious" data-current-step="2" data-previous-step="1">
                    <i class="fa-solid fa-arrow-left me-2"></i>Retour
                  </button>
                  <%= f.submit "Enregistrer", class: "btn button-default rounded-5" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>
